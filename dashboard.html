<!DOCTYPE html>
<html lang="en" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صراحة</title>
    <link rel="stylesheet" href="./components/fontawesome-free-6.5.2-web/css/all.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link rel="stylesheet" href="./components/styleHome.css">
    <style>

    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <a class="navbar-brand" href="#">
            <img src="./assets/blue-envelope.png" alt="Sarahaha Logo" class="logo">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item active">
                    <button class="nav-link btn btn-danger" onclick="openSignOutDialog()">تسجيل خروج</button>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="#">الاعدادت</a>
                </li>

            </ul>
        </div>
    </nav>

    <!-- Main Body -->
    <div class="container text-center mt-5">
        <div class="container">
            <div class="card card-profile shadow-sm mt--300">
                <div class="px-4">
                    <div class="row justify-content-center">
                        <div class="col-4">
                            <div class="card-profile-image">
                                <a role="button" data-toggle="modal" data-target="#modal-photo" href="#modal-photo">
                                    <img src="https://anofie.classiebit.com/upload/users/images/1562243911882_thumb.jpg"
                                        class="rounded-circle" style="top: -5.5rem;">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="h6 font-weight-300">
                        <i class="fas fa-share-alt mr-2"></i>
                        <h6 id="username" style="color: black;"></h6>
                        <h6 id="email"></h6>
                    </div>
                    <div class="h6 mt-3 mb-0">
                        Share Profile On
                    </div>
                    <div class="d-flex justify-content-center mb-2">
                        <div class="p-3">
                            <a title="Facebook"
                                href="https://www.facebook.com/sharer.php?u=https://x-brymo.github.io/sarahah-website/{${username}}&amp;quote=Review me honestly &amp;hashtag=%23anofie"
                                target="_blank"><small><i class="fab fa-facebook-square fa-2x"></i></small></a>
                        </div>
                        <div class="p-3">
                            <a title="Twitter" href="https://twitter.com/intent/tweet/?text=Review+me+honestly"
                                target="_blank"><small><i class="fab fa-twitter fa-2x"></i></small></a>
                        </div>
                        <div class="p-3">
                            <a title="Whatsapp"
                                href="https://api.whatsapp.com/send?text=Review me https://x-brymo.github.io/sarahah-website/{${username}}"
                                target="_blank"><small><i class="fab fa-whatsapp fa-2x"></i> </small></a>
                        </div>
                    </div>
                </div>

                <div class="container">
                    <div class="messages-container">
                        <ul class="nav">
                            <li><a href="#">الرسائل المفضله</a></li>
                            <li><a href="#">الرسائل المرسله</a></li>
                            <li class="active"><a href="#">الرسائل العامه</a></li>
                        </ul>
                        <div class="messages" id="messages"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Out Modal -->
    <div id="signOutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSignOutDialog()">&times;</span>
            <p>Are you sure you want to sign out?</p>
            <a onclick="signOut()" class="btn btn-danger">Yes, Sign Out</a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="script.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Function to handle sign-out
        function signOut() {
            console.log("Function to sign out");
            var header = Headers();
            var myToken = localStorage.getItem("token");
            header.append("authorization", "HAMADA__" + myToken);
            axios.post("https://saraha-gilt.vercel.app/auth/signout", {
                token: myToken
            }, {
                headers: header
            },
            ).then(response => {
                console.log(response);
                localStorage.clear();
                window.location.href = "/signin.html";
                console.log("User signed out");

            }).catch(error => {
                console.log(error);
            });

            closeSignOutDialog();
        }

        // Function to open sign-out dialog
        function openSignOutDialog() {
            document.getElementById("signOutModal").style.display = "block";
        }
        document.addEventListener('DOMContentLoaded', async function () {
            console.log("Function to get user data");
            const response = await axios.get("https://saraha-gilt.vercel.app/user", {
                headers: {
                    "authorization": "HAMADA__" + localStorage.getItem("token")
                }
            });
            console.log("Response:", response.data.user);
            try {
                if (response.status == 200) {
                    console.log( "MyData" + response.data.messages);
                    document.getElementById("username").innerHTML = response.data.user.userName
                    document.getElementById("email").innerHTML = response.data.user.email
                    console.log(response.data.user);
                    const myData = response.data.user;


                }
            } catch (error) {
                console.log("Server Error :" + response.data.message);
                alert("Server Error :" + response.data.message);

            }

        });
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Function to get sent messages");
            const response = axios.get("https://saraha-gilt.vercel.app/message/sentMessages?sort=-createdAt", {
                headers: {
                    "authorization": "HAMADA__" + localStorage.getItem("token"),
                }
            });
         
            console.log("Response:", response.data);
            try {
                if (response.status == 200) {
                    console.log(response.data);
                    var myData = response.data;
                    let cartona = ``;
                    for (const message of myData) {
                        cartona += `
                        <div class="message-card" data-id="${message._id}" data-username="${message.sender}">
                            <div class="message">
                                <div class="info">
                                    <i class="fa-regular fa-heart" id="favorite"></i>
                                    <div class="sender">
                                        <h5>${message.sender}</h5>
                                        <span>${message.createdAt}</span>
                                    </div>
                                </div>
                                <p>${message.text}</p>
                            </div>
                        </div>
                        `;
                    }
                    document.getElementById("messages").innerHTML = cartona

                }
            } catch (error) {
                console.log("Server Error sentMessage :" + response.data.message);
                alert("Server Error sentMessage :" + response.data.message);
            }
        })
        // Function to close sign-out dialog
        function closeSignOutDialog() {
            document.getElementById("signOutModal").style.display = "none";
        }


        $('.message-actions .btn-fav').click(function () {

            $(this).parent().parent().addClass('fav-message');

            var messageId = $(this).closest('.message-card').data('id');
            var favoriteMessages = JSON.parse(localStorage.getItem('favoriteMessages')) || [];
            favoriteMessages.push(messageId);
            localStorage.setItem('favoriteMessages', JSON.stringify(favoriteMessages));
        });

        $('.message-actions .btn-send').click(function () {

            var recipientUsername = $(this).closest('.message-card').data('username');

            console.log('Sending message to: ' + recipientUsername);
        });

        $('.nav-link').on('click', function (e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            var tabId = $(this).attr('href'); // Get the ID of the selected tab
            showTabContent(tabId); // Call a function to show the content of the selected tab
        });

        // Show content for the initial active tab
        showTabContent($('.nav-link.active').attr('href'));
        function addCardToFav() {
            var messageId = $(this).closest('.message-card').data('id');
            var favoriteMessages = JSON.parse(localStorage.getItem('favoriteMessages')) || [];
            favoriteMessages.push(messageId);
        }
        document.addEventListener("DOMContentLoaded", async function () {
            console.log("Function to get messages");
            const response = await axios.get("https://saraha-gilt.vercel.app/message/receivedMessages?sort=-createdAt", {
                headers: {
                    "authorization": "HAMADA__" + localStorage.getItem("token"),
                }
            });
            console.log("Response:", response.data.messages);
            try {
                if (response.status == 200) {
                    console.log(response.data.messages)
                    var myData = response.data.messages;
                    let cartona = ``;
                    for (const message of myData) {
                        cartona += `
                        <div class="message" >
                             <div class="info">
           <i class="fa-regular fa-heart" id="favorite"></i>
            <div class="sender">
                <span> ${message.date}</span>
                <h3>anonymous</h3>
            </div>
        </div>
        <p>
          ${message.text}
        </p>
    </div>
    `;
                        document.getElementById("messages").innerHTML = cartona
                    }

                }
            } catch (error) {
                console.log("Server Error receivedMessage :" + response.data.message);
                alert("Server Error receivedMessage :" + response.data.message);
            }
        })

    </script>
</body>

</html>